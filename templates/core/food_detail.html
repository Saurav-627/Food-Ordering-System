{% extends 'base.html' %}

{% block title %}{{ food.name }}{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
    <!-- Image Section -->
    <div class="relative group">
        {% if food.image %}
        <div class="aspect-square rounded-[2.5rem] overflow-hidden shadow-2xl shadow-orange-100 border-8 border-white">
            <img src="{{ food.image.url }}"
                class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-700"
                alt="{{ food.name }}">
        </div>
        {% else %}
        <div
            class="aspect-square rounded-[2.5rem] bg-orange-50 flex items-center justify-center text-orange-200 border-8 border-white shadow-xl shadow-orange-100">
            <i data-lucide="utensils" class="w-32 h-32 opacity-20"></i>
        </div>
        {% endif %}

        <div class="absolute top-6 left-6 bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-sm">
            <span class="flex items-center gap-1 text-primary font-bold">
                <i data-lucide="star" class="w-4 h-4 fill-primary"></i>
                {{ avg_rating|default:"0.0" }} <span class="text-gray-400 font-medium text-xs">({{ rating_count }}
                    reviews)</span>
            </span>
        </div>
    </div>

    <!-- Info Section -->
    <div class="space-y-8">
        <div>
            <nav class="flex text-sm text-gray-500 mb-4 items-center gap-2">
                <a href="{% url 'home' %}" class="hover:text-primary">Home</a>
                <i data-lucide="chevron-right" class="w-3 h-3"></i>
                <a href="{% url 'food_list' %}" class="hover:text-primary">Menu</a>
                <i data-lucide="chevron-right" class="w-3 h-3"></i>
                <span class="text-gray-900 font-medium">{{ food.name }}</span>
            </nav>
            <h1 class="text-5xl font-extrabold text-gray-900 leading-tight mb-2 uppercase tracking-tight">{{ food.name }}</h1>
            <div class="flex items-center gap-3">
                <span
                    class="px-3 py-1 bg-orange-100 text-primary text-xs font-bold rounded-full tracking-wider uppercase">
                    {{ food.category.name }}
                </span>
                <span class="flex items-center gap-1 text-gray-500 text-sm">
                    <i data-lucide="clock" class="w-4 h-4 text-teal"></i>
                    {{ food.prep_time_min }} mins
                </span>
            </div>
        </div>

        <div class="p-6 bg-white rounded-3xl border border-gray-100 shadow-sm">
            <p class="text-gray-600 leading-relaxed text-lg italic">
                "{{ food.description }}"
            </p>
        </div>

        <div class="flex items-end gap-2">
            <span class="text-gray-400 text-lg font-medium mb-1">Price:</span>
            <span class="text-4xl font-black text-primary">Rs. {{ food.price }}</span>
        </div>

        <!-- Add to Cart Form -->
        <form id="add-to-cart-form" action="{% url 'add_to_cart' food.id %}" method="post" class="space-y-6">
            {% csrf_token %}
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center bg-gray-100 p-1.5 rounded-2xl border border-gray-200">
                    <button type="button" onclick="decrementQty()"
                        class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white hover:shadow-md transition-all text-gray-600">
                        <i data-lucide="minus" class="w-4 h-4"></i>
                    </button>
                    <input type="number" id="quantity" name="quantity" value="1" min="1"
                        class="w-16 bg-transparent text-center font-bold text-lg focus:outline-none" readonly>
                    <button type="button" onclick="incrementQty()"
                        class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white hover:shadow-md transition-all text-gray-600">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                </div>

                <button type="submit" id="add-btn"
                    class="flex-1 btn-gradient text-white px-8 py-4 rounded-2xl font-bold text-lg flex items-center justify-center gap-3 shadow-xl shadow-orange-100 transition-all active:scale-95">
                    <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                    Add to Cart
                </button>
            </div>
        </form>

        <div class="grid grid-cols-3 gap-4 pt-4">
            <div class="text-center p-4 bg-gray-50 rounded-2xl border border-gray-100">
                <i data-lucide="shield-check" class="w-6 h-6 mx-auto text-teal mb-2"></i>
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Quality Assured</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-2xl border border-gray-100">
                <i data-lucide="truck" class="w-6 h-6 mx-auto text-primary mb-2"></i>
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Fast Delivery</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-2xl border border-gray-100">
                <i data-lucide="heart" class="w-6 h-6 mx-auto text-pink-500 mb-2"></i>
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Made with love</p>
            </div>
        </div>
    </div>
</div>

<!-- Related Foods Section -->
{% if related_foods %}
<div class="mt-24">
    <div class="flex flex-col lg:flex-row gap-16">
        <!-- Rating Form Section -->
        <div class="lg:w-2/5 space-y-8">
            <div class="space-y-4">
                <h2 class="text-3xl font-extrabold text-gray-900 tracking-tight uppercase">Customer Reviews</h2>
                <div class="h-1.5 w-20 bg-primary rounded-full"></div>
                <p class="text-gray-500 font-medium text-sm max-w-xs">We value your feedback! Help others by sharing
                    your experience.</p>
            </div>

            {% if user.is_authenticated %}
            <form action="{% url 'submit_review' food.id %}" method="post"
                class="bg-white p-10 rounded-[2.5rem] border border-gray-100 shadow-2xl shadow-gray-100/50 relative overflow-hidden group">
                <div
                    class="absolute top-0 right-0 w-32 h-32 bg-primary/5 rounded-full -mr-16 -mt-16 transition-transform group-hover:scale-110">
                </div>
                {% csrf_token %}

                <div class="relative z-10">
                    <p class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-6">Your Experience</p>

                    <div class="flex flex-col items-center mb-10">
                        <div class="flex items-center gap-1 mb-3" id="star-rating">
                            {% for i in "12345" %}
                            <button type="button" onclick="setRating({{ forloop.counter }})"
                                class="star-btn p-2 text-gray-200 hover:text-primary transition-all hover:scale-110 active:scale-95">
                                <i data-lucide="star" class="w-10 h-10"></i>
                            </button>
                            {% endfor %}
                            <input type="hidden" name="rating" id="rating-input" required>
                        </div>
                        <span id="rating-label"
                            class="text-xs font-black uppercase tracking-widest text-primary animate-pulse">Select a
                            Rating</span>
                    </div>

                    <div class="relative mb-8">
                        <textarea name="review" rows="4"
                            class="w-full p-8 bg-gray-50 border-2 border-transparent focus:border-primary/20 focus:bg-white focus:ring-0 rounded-3xl text-sm font-medium transition-all"
                            placeholder="How was the taste, presentation, and delivery?"></textarea>
                    </div>

                    <button type="submit"
                        class="w-full btn-gradient text-white py-5 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-orange-100 transition-all hover:shadow-orange-200 active:scale-[0.98]">
                        Post Review
                    </button>
                </div>
            </form>
            {% else %}
            <div class="bg-gray-50 p-10 rounded-[2.5rem] border border-dashed border-gray-200 text-center">
                <div class="w-16 h-16 bg-white rounded-2xl shadow-sm flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="lock" class="w-8 h-8 text-gray-300"></i>
                </div>
                <h4 class="text-sm font-black text-gray-900 uppercase mb-2">Login Required</h4>
                <p class="text-xs text-gray-500 font-medium mb-8">You need to be logged in to share your thoughts.</p>
                <a href="{% url 'login' %}"
                    class="inline-block bg-primary px-8 py-3 rounded-xl text-white font-black text-[10px] uppercase tracking-widest shadow-xl shadow-orange-100">Login
                    Now</a>
            </div>
            {% endif %}
        </div>

        <!-- Review List Section -->
        <div class="flex-1">
            <div class="space-y-8">
                {% for r in ratings %}
                <div
                    class="bg-white p-8 rounded-[2rem] border border-gray-50 shadow-sm hover:shadow-md transition-all duration-300 group">
                    <div class="flex items-start justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 bg-orange-100 rounded-2xl flex items-center justify-center text-primary font-black text-lg group-hover:bg-primary group-hover:text-white transition-colors">
                                {{ r.user.username|first|upper }}
                            </div>
                            <div>
                                <h4 class="font-black text-gray-900 uppercase text-sm tracking-tight mb-1">{{ r.user.username }}</h4>
                                <div class="flex gap-0.5 text-primary">
                                    {% for i in "12345" %}
                                    <i data-lucide="star"
                                        class="w-3.5 h-3.5 {% if forloop.counter <= r.rating %}fill-primary{% else %}text-gray-100{% endif %}"></i>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">{{ r.created_at|date:"M d, Y" }}</span>
                    </div>
                    <p
                        class="text-gray-600 font-medium leading-relaxed italic border-l-4 border-gray-50 pl-6 group-hover:border-primary/20 transition-colors">
                        "{{ r.review }}"</p>
                </div>
                {% empty %}
                <div class="text-center py-20 bg-gray-50/50 rounded-[3rem] border border-dashed border-gray-100">
                    <i data-lucide="message-square-dashed" class="w-16 h-16 text-gray-200 mx-auto mb-6"></i>
                    <p class="text-gray-400 font-black uppercase text-xs tracking-widest">No reviews yet. Be the first
                        to share!</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="mt-24">
    <div class="flex justify-between items-end mb-8">
        <div>
            <h2 class="text-3xl font-extrabold text-gray-900 tracking-tight uppercase">You might also like</h2>
            <div class="h-1.5 w-20 bg-primary rounded-full mt-2"></div>
        </div>
        <a href="{% url 'food_list' %}"
            class="text-primary font-bold flex items-center gap-2 hover:gap-3 transition-all">
            See all <i data-lucide="arrow-right" class="w-4 h-4"></i>
        </a>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
        {% for related in related_foods %}
        <a href="{% url 'food_detail' related.slug %}"
            class="group block bg-white rounded-3xl p-4 border border-gray-100 hover:border-primary/20 hover:shadow-2xl hover:shadow-orange-100 transition-all duration-500">
            <div class="aspect-square rounded-2xl overflow-hidden mb-4 bg-gray-50 relative">
                {% if related.image %}
                <img src="{{ related.image.url }}"
                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                    alt="{{ related.name }}">
                {% else %}
                <div class="w-full h-full flex items-center justify-center text-gray-200">
                    <i data-lucide="utensils" class="w-12 h-12"></i>
                </div>
                {% endif %}
                <div class="absolute bottom-2 right-2 bg-white/90 backdrop-blur px-2 py-1 rounded-lg shadow-sm">
                    <span class="text-xs font-bold text-primary italic">Rs. {{ related.price }}</span>
                </div>
            </div>
            <h5
                class="font-bold text-gray-900 mb-1 truncate group-hover:text-primary transition-colors uppercase tracking-tight text-sm">
                {{ related.name }}</h5>
            <p class="text-xs text-gray-500 font-medium">{{ related.category.name }}</p>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<script>
    function incrementQty() {
        const input = document.getElementById('quantity');
        input.value = parseInt(input.value) + 1;
    }

    function decrementQty() {
        const input = document.getElementById('quantity');
        if (parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
        }
    }

    function setRating(val) {
        document.getElementById('rating-input').value = val;
        const stars = document.querySelectorAll('.star-btn');
        const labels = {
            1: 'Terrible ðŸ˜ž',
            2: 'Poor ðŸ™',
            3: 'OK ðŸ˜',
            4: 'Good ðŸ™‚',
            5: 'Amazing! ðŸ˜'
        };

        document.getElementById('rating-label').innerText = labels[val];
        document.getElementById('rating-label').classList.remove('animate-pulse');

        stars.forEach((star, index) => {
            if (index < val) {
                star.classList.add('text-primary', 'scale-110');
                star.classList.remove('text-gray-200');
            } else {
                star.classList.remove('text-primary', 'scale-110');
                star.classList.add('text-gray-200');
            }
        });
    }

    // Handle AJAX Add to Cart
    document.getElementById('add-to-cart-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const form = this;
        const btn = document.getElementById('add-btn');
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i> Adding...';
        lucide.createIcons(); // Re-render loader icon

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update cart count
                    const countBadge = document.getElementById('cart-count');
                    const countBadgeMobile = document.getElementById('cart-count-mobile');
                    if (countBadge) countBadge.innerText = data.cart_count;
                    if (countBadgeMobile) countBadgeMobile.innerText = data.cart_count;

                    // Show success feedback
                    btn.innerHTML = '<i data-lucide="check-circle" class="w-6 h-6"></i> Added!';
                    btn.classList.remove('btn-gradient');
                    btn.classList.add('bg-teal', 'text-white');
                    lucide.createIcons();

                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.classList.add('btn-gradient');
                        btn.classList.remove('bg-teal', 'text-white');
                        lucide.createIcons();
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                btn.disabled = false;
                btn.innerHTML = originalText;
                lucide.createIcons();
            });
    });
</script>
{% endblock %}