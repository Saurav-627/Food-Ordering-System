{% extends 'base.html' %}

{% block title %}Checkout{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<!-- Leaflet Geocoder CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<style>
    #map {
        height: 400px;
        width: 100%;
        border-radius: 1.5rem;
        z-index: 10;
    }

    .leaflet-container {
        font-family: 'Outfit', sans-serif;
    }

    .leaflet-control-geocoder {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: none;
    }

    .leaflet-control-geocoder-form input {
        border-radius: 8px;
        padding: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-12">
    <nav class="flex text-sm text-gray-500 mb-4 items-center gap-2">
        <a href="{% url 'cart_view' %}" class="hover:text-primary">Cart</a>
        <i data-lucide="chevron-right" class="w-3 h-3"></i>
        <span class="text-gray-900 font-medium">Checkout</span>
    </nav>
    <h1 class="text-4xl font-extrabold text-gray-900 tracking-tighter uppercase">Secure <span
            class="text-primary italic">Checkout</span></h1>
    <div class="h-1.5 w-20 bg-primary rounded-full mt-3"></div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
    <!-- Delivery Address Section -->
    <div class="lg:col-span-2 space-y-8">
        <div class="bg-white rounded-[2.5rem] p-8 md:p-10 border border-gray-100 shadow-xl shadow-gray-50">
            <div class="flex items-center gap-4 mb-8">
                <div class="w-12 h-12 bg-orange-100 rounded-2xl flex items-center justify-center text-primary">
                    <i data-lucide="map-pin" class="w-6 h-6"></i>
                </div>
                <div>
                    <h2 class="text-xl font-black uppercase tracking-tight">Delivery Details</h2>
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">Where should we send your food?
                    </p>
                </div>
            </div>

            <form method="post" id="checkout-form" class="space-y-6">
                {% csrf_token %}
                <div class="space-y-2">
                    <label for="address-input"
                        class="block text-sm font-bold text-gray-700 uppercase tracking-widest">Delivery Address</label>
                    <div class="relative group">
                        <div
                            class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-primary transition-colors">
                            <i data-lucide="navigation" class="w-5 h-5"></i>
                        </div>
                        <input type="text" id="address-input" name="address" required
                            class="w-full pl-12 pr-4 py-4 bg-gray-50 border-transparent focus:bg-white focus:ring-4 focus:ring-primary/10 focus:border-primary rounded-2xl text-sm font-semibold transition-all"
                            placeholder="Enter your street address or pick from map...">
                    </div>
                    <input type="hidden" id="lat" name="lat" value="27.7172">
                    <input type="hidden" id="lng" name="lng" value="85.3240">
                </div>

                <!-- Map Container -->
                <div class="relative rounded-[2.5rem] overflow-hidden border-4 border-gray-50 shadow-inner bg-gray-100">
                    <div id="map"></div>
                    <div
                        class="absolute bottom-4 left-4 z-[1000] bg-white/90 backdrop-blur p-3 rounded-2xl shadow-lg border border-white/50 max-w-[200px]">
                        <p class="text-[10px] font-black uppercase tracking-widest text-primary mb-1">Status</p>
                        <p id="map-status" class="text-[10px] font-bold text-gray-500 leading-tight">Click on map to set
                            precise delivery location</p>
                    </div>
                </div>

                <div class="space-y-6 pt-6 border-t border-gray-100">
                    <div>
                        <h3 class="text-sm font-bold text-gray-700 uppercase tracking-widest mb-4">Select Payment Method
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- COD -->
                            <label
                                class="relative flex flex-col p-6 cursor-pointer bg-gray-50 rounded-2xl border-2 border-transparent hover:border-primary/20 transition-all has-[:checked]:border-primary has-[:checked]:bg-orange-50/50 group">
                                <input type="radio" name="payment_method" value="COD" class="sr-only">
                                <div
                                    class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center mb-4 text-gray-400 group-hover:text-primary transition-colors">
                                    <i data-lucide="banknote" class="w-6 h-6"></i>
                                </div>
                                <span class="font-bold text-sm text-gray-900 uppercase tracking-tight">Cash on
                                    Delivery</span>
                                <span class="text-[10px] text-gray-400 font-black uppercase mt-1">Pay when you
                                    receive</span>
                            </label>

                            <!-- eSewa -->
                            <label
                                class="relative flex flex-col p-6 cursor-pointer bg-gray-50 rounded-2xl border-2 border-transparent hover:border-primary/20 transition-all has-[:checked]:border-primary has-[:checked]:bg-orange-50/50 group">
                                <input type="radio" name="payment_method" value="ESEWA" class="sr-only">
                                <div
                                    class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center mb-4 overflow-hidden">
                                    <img src="https://esewa.com.np/common/images/esewa_logo.png"
                                        class="w-8 h-auto object-contain" alt="eSewa">
                                </div>
                                <span class="font-bold text-sm text-gray-900 uppercase tracking-tight">eSewa</span>
                                <span class="text-[10px] text-gray-400 font-black uppercase mt-1">Digital Wallet</span>
                            </label>

                            <!-- Khalti -->
                            <label
                                class="relative flex flex-col p-6 cursor-pointer bg-gray-50 rounded-2xl border-2 border-transparent hover:border-primary/20 transition-all has-[:checked]:border-primary has-[:checked]:bg-orange-50/50 group">
                                <input type="radio" name="payment_method" value="KHALTI" class="sr-only">
                                <div
                                    class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center mb-4 overflow-hidden">
                                    <img src="https://khalti.com/static/img/logo1.png" class="w-8 h-auto object-contain"
                                        alt="Khalti">
                                </div>
                                <span class="font-bold text-sm text-gray-900 uppercase tracking-tight">Khalti</span>
                                <span class="text-[10px] text-gray-400 font-black uppercase mt-1">Digital Wallet</span>
                            </label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Summary -->
    <div class="lg:col-span-1">
        <div class="bg-gray-900 rounded-[2.5rem] p-10 text-white shadow-2xl shadow-gray-200 sticky top-28">
            <h3 class="text-2xl font-black uppercase tracking-tight mb-8">Order Summary</h3>

            <div class="max-h-60 overflow-y-auto mb-8 pr-2 custom-scrollbar">
                <div class="space-y-4">
                    {% for item in cart.items.all %}
                    <div class="flex justify-between items-center gap-4">
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-sm truncate uppercase tracking-tight">{{ item.food.name }}</p>
                            <p class="text-[10px] text-gray-500 font-black uppercase">Qty: {{ item.quantity }}</p>
                        </div>
                        <span class="text-sm font-black text-gray-300">Rs. {{ item.total_price }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="space-y-4 mb-8 border-t border-white/10 pt-8">
                <div class="flex justify-between text-gray-400 font-medium">
                    <span>Subtotal</span>
                    <span>Rs. {{ cart.total_price }}</span>
                </div>
                <div class="flex justify-between text-gray-400 font-medium">
                    <span>Delivery</span>
                    <span class="text-teal">FREE</span>
                </div>
                <div class="h-px bg-white/10 my-2"></div>
                <div class="flex justify-between items-end">
                    <span class="text-gray-400 font-bold uppercase text-xs tracking-widest">Total to Pay</span>
                    <span class="text-4xl font-black text-primary">Rs. {{ cart.total_price }}</span>
                </div>
            </div>

            <button type="submit" form="checkout-form"
                class="btn-gradient w-full flex items-center justify-center py-5 rounded-2xl font-black text-lg uppercase tracking-wider shadow-xl shadow-orange-950/20 active:scale-95 transition-all">
                Place Order <i data-lucide="check-circle" class="w-5 h-5 ml-2"></i>
            </button>

            <p class="text-[10px] text-center text-gray-500 font-bold uppercase tracking-widest mt-6">
                By placing an order, you agree to our <br> Terms & Conditions
            </p>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 75, 43, 0.3);
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- Leaflet Geocoder JS -->
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const initialLat = 27.7172;
        const initialLng = 85.3240;

        // Initialize Map
        const map = L.map('map').setView([initialLat, initialLng], 13);

        // Add OSM Tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Custom Marker Icon
        const deliveryIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        let marker = L.marker([initialLat, initialLng], { icon: deliveryIcon, draggable: true }).addTo(map);

        // Add Geocoder (Search)
        const geocoder = L.Control.geocoder({
            defaultMarkGeocode: false,
            placeholder: "Search for a place...",
            position: 'topleft'
        })
            .on('markgeocode', function (e) {
                const latlng = e.geocode.center;
                marker.setLatLng(latlng);
                map.setView(latlng, 16);
                updateLocation(latlng.lat, latlng.lng, e.geocode.name);
            })
            .addTo(map);

        // Map Click Event
        map.on('click', function (e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            marker.setLatLng(e.latlng);
            reverseGeocode(lat, lng);
        });

        // Marker Drag Event
        marker.on('dragend', function (e) {
            const position = marker.getLatLng();
            reverseGeocode(position.lat, position.lng);
        });

        function reverseGeocode(lat, lng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    const address = data.display_name;
                    updateLocation(lat, lng, address);
                })
                .catch(err => {
                    updateLocation(lat, lng, "Custom location selected");
                });
        }

        function updateLocation(lat, lng, address) {
            document.getElementById('lat').value = lat;
            document.getElementById('lng').value = lng;
            document.getElementById('address-input').value = address;
            document.getElementById('map-status').innerText = "Location set: " + (address.substring(0, 30) + "...");
        }

        // Try to get user's current location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                map.setView([lat, lng], 15);
                marker.setLatLng([lat, lng]);
                reverseGeocode(lat, lng);
            });
        }
    });
</script>
{% endblock %}